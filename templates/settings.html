{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Settings</h1>
    
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <div class="list-group">
                <a href="#tag-management" class="list-group-item list-group-item-action active" data-bs-toggle="list">Tag Management</a>
                <a href="#general-settings" class="list-group-item list-group-item-action" data-bs-toggle="list">General Settings</a>
            </div>
        </div>
        
        <!-- Settings Content -->
        <div class="col-md-9">
            <div class="tab-content">
                <!-- Tag Management -->
                <div class="tab-pane fade show active" id="tag-management">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Manage Tags</h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTagModal">
                                <i class="bi bi-plus-lg"></i> Add New Tag
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Tags help you organize your saved queries. You can add, edit, or delete tags here.
                            </div>
                            
                            <div id="tagsContainer">
                                <div class="text-center py-4" id="loadingTags">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading tags...</p>
                                </div>
                                
                                <div id="noTagsMessage" style="display: none;">
                                    <p class="text-muted">No tags created yet. Click "Add New Tag" to create your first tag.</p>
                                </div>
                                
                                <div class="table-responsive" id="tagsTable" style="display: none;">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tag Name</th>
                                                <th>Color</th>
                                                <th>Description</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tagsList">
                                            <!-- Tags will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- General Settings -->
                <div class="tab-pane fade" id="general-settings">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">General Settings</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Configure general application settings here.</p>
                            
                            <form id="generalSettingsForm">
                                <div class="mb-3">
                                    <label for="defaultRowsPerPage" class="form-label">Default Rows Per Page</label>
                                    <select id="defaultRowsPerPage" class="form-select">
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="defaultTimeWindow" class="form-label">Default Time Window</label>
                                    <select id="defaultTimeWindow" class="form-select">
                                        <option value="none">No Time Filter</option>
                                        <option value="last_day">Last 24 Hours</option>
                                        <option value="last_week">Last 7 Days</option>
                                        <option value="last_month">Last 30 Days</option>
                                        <option value="this_month">This Month</option>
                                    </select>
                                </div>
                                
                                <button type="button" class="btn btn-primary" onclick="saveGeneralSettings()">
                                    Save Settings
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Tag Modal -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTagModalLabel">Add New Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTagForm">
                    <div class="mb-3">
                        <label for="tagName" class="form-label">Tag Name</label>
                        <input type="text" class="form-control" id="tagName" required maxlength="50" placeholder="Enter tag name">
                    </div>
                    <div class="mb-3">
                        <label for="tagColor" class="form-label">Tag Color</label>
                        <input type="color" class="form-control form-control-color" id="tagColor" value="#0d6efd">
                    </div>
                    <div class="mb-3">
                        <label for="tagDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="tagDescription" rows="2" placeholder="Describe the purpose of this tag"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTag()">Add Tag</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Tag Modal -->
<div class="modal fade" id="editTagModal" tabindex="-1" aria-labelledby="editTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTagModalLabel">Edit Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTagForm">
                    <input type="hidden" id="editTagId">
                    <div class="mb-3">
                        <label for="editTagName" class="form-label">Tag Name</label>
                        <input type="text" class="form-control" id="editTagName" required maxlength="50">
                    </div>
                    <div class="mb-3">
                        <label for="editTagColor" class="form-label">Tag Color</label>
                        <input type="color" class="form-control form-control-color" id="editTagColor">
                    </div>
                    <div class="mb-3">
                        <label for="editTagDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="editTagDescription" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateTag()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Tag Confirmation Modal -->
<div class="modal fade" id="deleteTagModal" tabindex="-1" aria-labelledby="deleteTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTagModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the tag "<span id="deleteTagName"></span>"?</p>
                <p class="text-danger">This action cannot be undone. Queries that use this tag will have the tag removed.</p>
                <input type="hidden" id="deleteTagId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteTag()">Delete Tag</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<script>
// Global variables
let allTags = [];

// Load tags when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadTags();
    loadGeneralSettings();
});

// Function to load tags from the server
function loadTags() {
    document.getElementById('loadingTags').style.display = 'block';
    document.getElementById('noTagsMessage').style.display = 'none';
    document.getElementById('tagsTable').style.display = 'none';
    
    fetch('/get_tags')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingTags').style.display = 'none';
            
            if (data.success && data.tags && data.tags.length > 0) {
                allTags = data.tags;
                displayTags(allTags);
                document.getElementById('tagsTable').style.display = 'block';
            } else {
                document.getElementById('noTagsMessage').style.display = 'block';
            }
        })
        .catch(error => {
            document.getElementById('loadingTags').style.display = 'none';
            document.getElementById('noTagsMessage').style.display = 'block';
            console.error('Error loading tags:', error);
        });
}

// Function to display tags
function displayTags(tags) {
    const tagsListElement = document.getElementById('tagsList');
    tagsListElement.innerHTML = '';
    
    tags.forEach(tag => {
        const row = document.createElement('tr');
        
        // Tag name with color
        const nameCell = document.createElement('td');
        const tagBadge = document.createElement('span');
        tagBadge.className = 'badge';
        tagBadge.style.backgroundColor = tag.color;
        tagBadge.style.color = getContrastYIQ(tag.color);
        tagBadge.textContent = tag.name;
        nameCell.appendChild(tagBadge);
        
        // Color display
        const colorCell = document.createElement('td');
        const colorBox = document.createElement('div');
        colorBox.style.width = '20px';
        colorBox.style.height = '20px';
        colorBox.style.backgroundColor = tag.color;
        colorBox.style.borderRadius = '4px';
        colorCell.appendChild(colorBox);
        
        // Description
        const descCell = document.createElement('td');
        descCell.textContent = tag.description || '-';
        
        // Actions
        const actionsCell = document.createElement('td');
        
        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-outline-primary me-2';
        editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.title = 'Edit tag';
        editBtn.onclick = function() { showEditTagModal(tag.id); };
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        deleteBtn.title = 'Delete tag';
        deleteBtn.onclick = function() { showDeleteTagModal(tag.id); };
        
        actionsCell.appendChild(editBtn);
        actionsCell.appendChild(deleteBtn);
        
        // Add cells to row
        row.appendChild(nameCell);
        row.appendChild(colorCell);
        row.appendChild(descCell);
        row.appendChild(actionsCell);
        
        // Add row to table
        tagsListElement.appendChild(row);
    });
}

// Function to get contrasting text color (black or white) based on background
function getContrastYIQ(hexcolor) {
    // If color doesn't start with #, add it
    if (hexcolor.charAt(0) !== '#') {
        hexcolor = '#' + hexcolor;
    }
    
    // Convert hex to RGB
    const r = parseInt(hexcolor.substr(1, 2), 16);
    const g = parseInt(hexcolor.substr(3, 2), 16);
    const b = parseInt(hexcolor.substr(5, 2), 16);
    
    // Calculate YIQ formula
    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
    
    // Return black or white based on YIQ
    return (yiq >= 128) ? 'black' : 'white';
}

// Function to add a new tag
function addTag() {
    const tagName = document.getElementById('tagName').value.trim();
    const tagColor = document.getElementById('tagColor').value;
    const tagDescription = document.getElementById('tagDescription').value.trim();
    
    if (!tagName) {
        alert('Tag name is required');
        return;
    }
    
    // Create tag object
    const tagData = {
        name: tagName,
        color: tagColor,
        description: tagDescription
    };
    
    // Send to server
    fetch('/add_tag', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(tagData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reset form
            document.getElementById('tagName').value = '';
            document.getElementById('tagDescription').value = '';
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTagModal'));
            modal.hide();
            
            // Reload tags
            loadTags();
            
            // Show success message
            alert('Tag added successfully!');
        } else {
            alert('Error adding tag: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error adding tag: ' + error.message);
        console.error(error);
    });
}

// Function to show the edit tag modal
function showEditTagModal(tagId) {
    const tag = allTags.find(t => t.id === tagId);
    if (!tag) return;
    
    // Populate form
    document.getElementById('editTagId').value = tag.id;
    document.getElementById('editTagName').value = tag.name;
    document.getElementById('editTagColor').value = tag.color;
    document.getElementById('editTagDescription').value = tag.description || '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editTagModal'));
    modal.show();
}

// Function to update a tag
function updateTag() {
    const tagId = document.getElementById('editTagId').value;
    const tagName = document.getElementById('editTagName').value.trim();
    const tagColor = document.getElementById('editTagColor').value;
    const tagDescription = document.getElementById('editTagDescription').value.trim();
    
    if (!tagName) {
        alert('Tag name is required');
        return;
    }
    
    // Create tag object
    const tagData = {
        id: tagId,
        name: tagName,
        color: tagColor,
        description: tagDescription
    };
    
    // Send to server
    fetch('/update_tag', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(tagData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTagModal'));
            modal.hide();
            
            // Reload tags
            loadTags();
            
            // Show success message
            alert('Tag updated successfully!');
        } else {
            alert('Error updating tag: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error updating tag: ' + error.message);
        console.error(error);
    });
}

// Function to show the delete tag confirmation modal
function showDeleteTagModal(tagId) {
    const tag = allTags.find(t => t.id === tagId);
    if (!tag) return;
    
    // Populate modal
    document.getElementById('deleteTagId').value = tag.id;
    document.getElementById('deleteTagName').textContent = tag.name;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteTagModal'));
    modal.show();
}

// Function to delete a tag
function deleteTag() {
    const tagId = document.getElementById('deleteTagId').value;
    
    // Send to server
    fetch(`/delete_tag/${tagId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteTagModal'));
            modal.hide();
            
            // Reload tags
            loadTags();
            
            // Show success message
            alert('Tag deleted successfully!');
        } else {
            alert('Error deleting tag: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error deleting tag: ' + error.message);
        console.error(error);
    });
}

// Function to load general settings
function loadGeneralSettings() {
    fetch('/get_settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                
                // Populate form with current settings
                if (settings.defaultRowsPerPage) {
                    document.getElementById('defaultRowsPerPage').value = settings.defaultRowsPerPage;
                }
                if (settings.defaultTimeWindow) {
                    document.getElementById('defaultTimeWindow').value = settings.defaultTimeWindow;
                }
            }
        })
        .catch(error => {
            console.error('Error loading settings:', error);
        });
}

// Function to save general settings
function saveGeneralSettings() {
    const defaultRowsPerPage = document.getElementById('defaultRowsPerPage').value;
    const defaultTimeWindow = document.getElementById('defaultTimeWindow').value;
    
    const settingsData = {
        defaultRowsPerPage: defaultRowsPerPage,
        defaultTimeWindow: defaultTimeWindow
    };
    
    fetch('/save_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settingsData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Settings saved successfully!');
        } else {
            alert('Error saving settings: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error saving settings: ' + error.message);
        console.error(error);
    });
}
</script>
{% endblock %} 