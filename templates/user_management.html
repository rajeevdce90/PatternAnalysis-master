{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4"><i class="bi bi-people"></i> User Management</h1>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-plus"></i> Add New User</h5>
                </div>
                <div class="card-body">
                    <form id="add-user-form">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">Role</label>
                            <select class="form-select" id="role" name="role" required>
                                <option value="">Select a role</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}">{{ role.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add User</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Manage Roles</h5>
                </div>
                <div class="card-body">
                    <form id="add-role-form" class="mb-4">
                        <div class="mb-3">
                            <label for="role-name" class="form-label">Role Name</label>
                            <input type="text" class="form-control" id="role-name" name="role-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="role-description" class="form-label">Description</label>
                            <textarea class="form-control" id="role-description" name="role-description" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Role</button>
                    </form>
                    
                    <div class="roles-list mt-4">
                        <h6 class="mb-3">Available Roles</h6>
                        <div class="list-group" id="roles-container">
                            {% for role in roles %}
                            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ role.name }}</strong>
                                    {% if role.description %}
                                    <p class="mb-0 small text-muted">{{ role.description }}</p>
                                    {% endif %}
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary edit-role-btn" data-id="{{ role.id }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-role-btn" data-id="{{ role.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-people"></i> User List</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        {% for user in users %}
                        <tr data-id="{{ user.id }}">
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% for role in roles %}
                                    {% if role.id == user.role_id %}
                                        {{ role.name }}
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td>{{ user.created_at }}</td>
                            <td>
                                {% if user.is_active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-user-btn" data-id="{{ user.id }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-user-btn" data-id="{{ user.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    <div class="mb-3">
                        <label for="edit-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="edit-username" name="edit-username" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="edit-email" name="edit-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-password" class="form-label">Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="edit-password" name="edit-password">
                    </div>
                    <div class="mb-3">
                        <label for="edit-role" class="form-label">Role</label>
                        <select class="form-select" id="edit-role" name="edit-role" required>
                            <option value="">Select a role</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="edit-is-active" name="edit-is-active">
                        <label class="form-check-label" for="edit-is-active">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-user-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1" aria-labelledby="editRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRoleModalLabel">Edit Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-role-form">
                    <input type="hidden" id="edit-role-id">
                    <div class="mb-3">
                        <label for="edit-role-name" class="form-label">Role Name</label>
                        <input type="text" class="form-control" id="edit-role-name" name="edit-role-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-role-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-role-description" name="edit-role-description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tag Access</label>
                        <div id="tag-access-container" class="p-3 border rounded">
                            <!-- Tags will be loaded here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-role-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete confirmation modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this <span id="delete-item-type">item</span>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add User Form Submission
    document.getElementById('add-user-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const roleId = document.getElementById('role').value;
        
        fetch('/api/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                email: email,
                password: password,
                role_id: roleId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Refresh the page to show the new user
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the user.');
        });
    });
    
    // Add Role Form Submission
    document.getElementById('add-role-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('role-name').value;
        const description = document.getElementById('role-description').value;
        
        fetch('/api/roles', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Refresh the page to show the new role
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the role.');
        });
    });
    
    // Edit User Modal
    const editUserBtns = document.querySelectorAll('.edit-user-btn');
    const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    
    editUserBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-id');
            const userRow = document.querySelector(`tr[data-id="${userId}"]`);
            
            // Populate form with user data
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-username').value = userRow.cells[0].textContent;
            document.getElementById('edit-email').value = userRow.cells[1].textContent;
            document.getElementById('edit-password').value = ''; // Clear password field
            
            // Find role ID from role name
            const roleName = userRow.cells[2].textContent.trim();
            const roleSelect = document.getElementById('edit-role');
            
            for (let i = 0; i < roleSelect.options.length; i++) {
                if (roleSelect.options[i].textContent === roleName) {
                    roleSelect.selectedIndex = i;
                    break;
                }
            }
            
            // Set active status
            document.getElementById('edit-is-active').checked = 
                userRow.cells[4].querySelector('.badge').classList.contains('bg-success');
            
            // Show the modal
            editUserModal.show();
        });
    });
    
    // Save User Changes
    document.getElementById('save-user-btn').addEventListener('click', function() {
        const userId = document.getElementById('edit-user-id').value;
        const username = document.getElementById('edit-username').value;
        const email = document.getElementById('edit-email').value;
        const password = document.getElementById('edit-password').value;
        const roleId = document.getElementById('edit-role').value;
        const isActive = document.getElementById('edit-is-active').checked;
        
        const userData = {
            username: username,
            email: email,
            role_id: roleId,
            is_active: isActive
        };
        
        // Only include password if it's not empty
        if (password) {
            userData.password = password;
        }
        
        fetch(`/api/users/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Close the modal and refresh
                editUserModal.hide();
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the user.');
        });
    });
    
    // Edit Role Modal
    const editRoleBtns = document.querySelectorAll('.edit-role-btn');
    const editRoleModal = new bootstrap.Modal(document.getElementById('editRoleModal'));
    
    // Load available tags for role editing
    function loadTagsForRole(roleId) {
        fetch('/get_tags')
        .then(response => response.json())
        .then(tags => {
            const container = document.getElementById('tag-access-container');
            container.innerHTML = '';
            
            // Get role's current tag access
            fetch(`/api/roles/${roleId}`)
            .then(response => response.json())
            .then(role => {
                const tagAccess = role.tag_access || [];
                
                // Create tag checkboxes
                tags.forEach(tag => {
                    const tagDiv = document.createElement('div');
                    tagDiv.className = 'form-check mb-2';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'form-check-input tag-checkbox';
                    checkbox.id = `tag-${tag.id}`;
                    checkbox.value = tag.id;
                    checkbox.checked = tagAccess.includes(tag.id);
                    
                    const label = document.createElement('label');
                    label.className = 'form-check-label';
                    label.htmlFor = `tag-${tag.id}`;
                    
                    // Create color badge
                    const badge = document.createElement('span');
                    badge.className = 'badge me-2';
                    badge.style.backgroundColor = tag.color;
                    badge.innerHTML = '&nbsp;&nbsp;&nbsp;';
                    
                    label.appendChild(badge);
                    label.appendChild(document.createTextNode(tag.name));
                    
                    tagDiv.appendChild(checkbox);
                    tagDiv.appendChild(label);
                    container.appendChild(tagDiv);
                });
            });
        })
        .catch(error => {
            console.error('Error loading tags:', error);
        });
    }
    
    editRoleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const roleId = this.getAttribute('data-id');
            const roleItem = this.closest('.list-group-item');
            
            // Fetch role details
            fetch(`/api/roles/${roleId}`)
            .then(response => response.json())
            .then(role => {
                // Populate form with role data
                document.getElementById('edit-role-id').value = roleId;
                document.getElementById('edit-role-name').value = role.name;
                document.getElementById('edit-role-description').value = role.description || '';
                
                // Load tags for this role
                loadTagsForRole(roleId);
                
                // Show the modal
                editRoleModal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while loading role data.');
            });
        });
    });
    
    // Save Role Changes
    document.getElementById('save-role-btn').addEventListener('click', function() {
        const roleId = document.getElementById('edit-role-id').value;
        const name = document.getElementById('edit-role-name').value;
        const description = document.getElementById('edit-role-description').value;
        
        // Get selected tags
        const tagCheckboxes = document.querySelectorAll('.tag-checkbox:checked');
        const tagAccess = Array.from(tagCheckboxes).map(checkbox => checkbox.value);
        
        fetch(`/api/roles/${roleId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description,
                tag_access: tagAccess
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Close the modal and refresh
                editRoleModal.hide();
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the role.');
        });
    });
    
    // Delete User
    const deleteUserBtns = document.querySelectorAll('.delete-user-btn');
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    
    deleteUserBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-id');
            document.getElementById('delete-item-type').textContent = 'user';
            
            confirmDeleteBtn.onclick = function() {
                fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        deleteConfirmModal.hide();
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the user.');
                });
            };
            
            deleteConfirmModal.show();
        });
    });
    
    // Delete Role
    const deleteRoleBtns = document.querySelectorAll('.delete-role-btn');
    
    deleteRoleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const roleId = this.getAttribute('data-id');
            document.getElementById('delete-item-type').textContent = 'role';
            
            confirmDeleteBtn.onclick = function() {
                fetch(`/api/roles/${roleId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        deleteConfirmModal.hide();
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the role.');
                });
            };
            
            deleteConfirmModal.show();
        });
    });
});
</script>
{% endblock %} 