{% extends "base.html" %}

{% block head %}
<!-- Prism.js for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
<style>
    .loading {
        position: relative;
        pointer-events: none;
        opacity: 0.6;
    }
    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 1.5rem;
        height: 1.5rem;
        margin: -0.75rem 0 0 -0.75rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--olympic-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #alertContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }
    .alert-float {
        min-width: 300px;
        margin-bottom: 10px;
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    .editable-field {
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.375rem 0.75rem;
    }
    
    .editable-field:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .CodeMirror {
        height: auto;
        min-height: 200px;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }
</style>
<!-- Add CodeMirror for SQL editing -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
{% endblock %}

{% block content %}
<div id="alertContainer"></div>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>Saved Queries</h2>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search queries...">
                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="typeFilter">
                <option value="">All Types</option>
                <option value="query">Saved Query</option>
                <option value="alert">Alert</option>
                <option value="report">Report</option>
                <option value="dashboard">Dashboard Widget</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="sortBy">
                <option value="name">Sort by Name</option>
                <option value="created">Sort by Created Date</option>
                <option value="updated">Sort by Updated Date</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Created</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="queriesTableBody">
                        {% for query in queries %}
                        <tr data-query-id="{{ query.id }}">
                            <td>{{ query.name }}</td>
                            <td>{{ query.description }}</td>
                            <td><span class="badge bg-{{ query.type_class }}">{{ query.type }}</span></td>
                            <td>{{ query.created_at }}</td>
                            <td>{{ query.updated_at if query.updated_at else query.created_at }}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewQuery('{{ query.id }}', event)">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="runQuery('{{ query.id }}', event)">
                                        <i class="bi bi-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteQuery('{{ query.id }}', event)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if not queries %}
            <div class="alert alert-info">No saved queries found.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- View/Edit Query Modal -->
<div class="modal fade" id="viewQueryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Query Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="queryEditForm">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="queryName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="queryDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Query</label>
                        <textarea id="queryText"></textarea>
                    </div>
                    <div id="queryOptions"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" onclick="deleteQuery(currentQueryId, event)">Delete</button>
                <button type="button" class="btn btn-outline-primary" onclick="createAlert(event)">Create Alert</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="saveQuery(event)">Save Changes</button>
                <button type="button" class="btn btn-primary" onclick="runQuery(currentQueryId, event)">Run Query</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Prism.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/line-numbers/prism-line-numbers.min.js"></script>

<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>

<script>
let currentQueryId = null;
let editor = null;

function showAlert(type, message, duration = 5000) {
    const alertContainer = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-float alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 300);
    }, duration);
}

function setLoading(element, isLoading) {
    if (isLoading) {
        element.classList.add('loading');
        if (element.tagName === 'BUTTON') {
            element.disabled = true;
        }
    } else {
        element.classList.remove('loading');
        if (element.tagName === 'BUTTON') {
            element.disabled = false;
        }
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    filterQueries();
}

function filterQueries() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const rows = document.getElementById('queriesTableBody').getElementsByTagName('tr');

    for (let row of rows) {
        const name = row.cells[0].textContent.toLowerCase();
        const description = row.cells[1].textContent.toLowerCase();
        const type = row.cells[2].textContent.toLowerCase();

        const matchesSearch = name.includes(searchTerm) || description.includes(searchTerm);
        const matchesType = !typeFilter || type === typeFilter;

        row.style.display = matchesSearch && matchesType ? '' : 'none';
    }
}

function sortQueries() {
    const sortBy = document.getElementById('sortBy').value;
    const tbody = document.getElementById('queriesTableBody');
    const rows = Array.from(tbody.getElementsByTagName('tr'));

    rows.sort((a, b) => {
        let aValue, bValue;
        switch (sortBy) {
            case 'name':
                aValue = a.cells[0].textContent;
                bValue = b.cells[0].textContent;
                break;
            case 'created':
                aValue = new Date(a.cells[3].textContent);
                bValue = new Date(b.cells[3].textContent);
                break;
            case 'updated':
                aValue = new Date(a.cells[4].textContent);
                bValue = new Date(b.cells[4].textContent);
                break;
        }
        return aValue > bValue ? 1 : -1;
    });

    rows.forEach(row => tbody.appendChild(row));
}

async function viewQuery(queryId, event) {
    if (event) {
        const button = event.target.closest('button');
        setLoading(button, true);
    }
    
    currentQueryId = queryId;
    const modal = document.getElementById('viewQueryModal');
    
    try {
        const response = await fetch(`/api/queries/${queryId}`);
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to fetch query details: ${errorText}`);
        }
        
        const query = await response.json();
        document.getElementById('queryName').value = query.name || '';
        document.getElementById('queryDescription').value = query.description || '';
        
        // Initialize CodeMirror if not already initialized
        if (!editor) {
            editor = CodeMirror.fromTextArea(document.getElementById('queryText'), {
                mode: 'text/x-sql',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                lineWrapping: true
            });
        }
        editor.setValue(query.query || '');
        
        // Update options based on query type
        const optionsDiv = document.getElementById('queryOptions');
        optionsDiv.innerHTML = '';
        
        if (query.type === 'alert') {
            optionsDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Threshold</label>
                        <input type="number" class="form-control" id="threshold" value="${query.threshold || ''}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Condition</label>
                        <select class="form-select" id="condition">
                            <option value="greater_than" ${query.condition === 'greater_than' ? 'selected' : ''}>Greater Than</option>
                            <option value="less_than" ${query.condition === 'less_than' ? 'selected' : ''}>Less Than</option>
                            <option value="equals" ${query.condition === 'equals' ? 'selected' : ''}>Equals</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Frequency (min)</label>
                        <input type="number" class="form-control" id="frequency" value="${query.frequency || ''}">
                    </div>
                </div>
            `;
        } else if (query.type === 'report') {
            optionsDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Schedule</label>
                        <input type="text" class="form-control" id="reportSchedule" value="${query.report_schedule || ''}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Format</label>
                        <select class="form-select" id="reportFormat">
                            <option value="pdf" ${query.report_format === 'pdf' ? 'selected' : ''}>PDF</option>
                            <option value="csv" ${query.report_format === 'csv' ? 'selected' : ''}>CSV</option>
                            <option value="excel" ${query.report_format === 'excel' ? 'selected' : ''}>Excel</option>
                        </select>
                    </div>
                </div>
            `;
        } else if (query.type === 'dashboard') {
            optionsDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Layout</label>
                        <select class="form-select" id="dashboardLayout">
                            <option value="grid" ${query.dashboard_layout === 'grid' ? 'selected' : ''}>Grid</option>
                            <option value="horizontal" ${query.dashboard_layout === 'horizontal' ? 'selected' : ''}>Horizontal</option>
                            <option value="vertical" ${query.dashboard_layout === 'vertical' ? 'selected' : ''}>Vertical</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Refresh Interval (sec)</label>
                        <input type="number" class="form-control" id="refreshInterval" value="${query.refresh_interval || '0'}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Visualization</label>
                        <select class="form-select" id="defaultVisualization">
                            <option value="table" ${query.default_visualization === 'table' ? 'selected' : ''}>Table</option>
                            <option value="line" ${query.default_visualization === 'line' ? 'selected' : ''}>Line Chart</option>
                            <option value="bar" ${query.default_visualization === 'bar' ? 'selected' : ''}>Bar Chart</option>
                            <option value="pie" ${query.default_visualization === 'pie' ? 'selected' : ''}>Pie Chart</option>
                        </select>
                    </div>
                </div>
            `;
        }
        
        // Show the modal
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
    } catch (error) {
        console.error('Error fetching query:', error);
        showAlert('danger', 'Failed to load query details: ' + error.message);
    } finally {
        if (event) {
            const button = event.target.closest('button');
            setLoading(button, false);
        }
    }
}

async function saveQuery(event) {
    if (!currentQueryId) return;
    
    const button = event.target;
    setLoading(button, true);
    
    try {
        const formData = {
            name: document.getElementById('queryName').value,
            description: document.getElementById('queryDescription').value,
            query: editor.getValue()
        };
        
        // Add type-specific options
        if (document.getElementById('threshold')) {
            formData.threshold = document.getElementById('threshold').value;
            formData.condition = document.getElementById('condition').value;
            formData.frequency = document.getElementById('frequency').value;
        } else if (document.getElementById('reportSchedule')) {
            formData.report_schedule = document.getElementById('reportSchedule').value;
            formData.report_format = document.getElementById('reportFormat').value;
        } else if (document.getElementById('dashboardLayout')) {
            formData.dashboard_layout = document.getElementById('dashboardLayout').value;
            formData.refresh_interval = document.getElementById('refreshInterval').value;
            formData.default_visualization = document.getElementById('defaultVisualization').value;
        }
        
        const response = await fetch(`/api/queries/${currentQueryId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to save query: ${errorText}`);
        }
        
        const result = await response.json();
        
        // Update the table row
        const row = document.querySelector(`tr[data-query-id="${currentQueryId}"]`);
        if (row) {
            row.cells[0].textContent = formData.name;
            row.cells[1].textContent = formData.description;
            row.cells[4].textContent = new Date().toLocaleString();
        }
        
        showAlert('success', 'Query saved successfully');
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('viewQueryModal'));
        if (modal) modal.hide();
    } catch (error) {
        console.error('Error saving query:', error);
        showAlert('danger', 'Failed to save query: ' + error.message);
    } finally {
        setLoading(button, false);
    }
}

async function runQuery(queryId, event) {
    if (!queryId) return;
    
    let button = null;
    if (event) {
        button = event.target.closest('button');
        setLoading(button, true);
    }
    
    try {
        const response = await fetch(`/api/queries/${queryId}/run`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to run query: ${errorText}`);
        }
        
        const result = await response.json();
        if (result.redirect_url) {
            window.location.href = result.redirect_url;
        } else {
            showAlert('success', 'Query executed successfully');
        }
    } catch (error) {
        console.error('Error running query:', error);
        showAlert('danger', 'Failed to run query: ' + error.message);
    } finally {
        if (button) {
            setLoading(button, false);
        }
    }
}

async function deleteQuery(queryId, event) {
    if (!queryId) return;
    if (!confirm('Are you sure you want to delete this query?')) return;
    
    let button = null;
    if (event) {
        button = event.target.closest('button');
        setLoading(button, true);
    }
    
    try {
        const response = await fetch(`/delete_query/${queryId}`, { method: 'DELETE' });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to delete query: ${errorText}`);
        }
        
        // Try to get the JSON response
        const result = await response.json().catch(() => ({ success: true }));
        
        // Close modal if open
        try {
            const modal = bootstrap.Modal.getInstance(document.getElementById('viewQueryModal'));
            if (modal) modal.hide();
        } catch (modalError) {
            console.warn('Modal error:', modalError);
        }
        
        // Remove row from table
        const row = document.querySelector(`tr[data-query-id="${queryId}"]`);
        if (row) {
            row.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => row.remove(), 300);
        }
        
        showAlert('success', 'Query deleted successfully');
    } catch (error) {
        console.error('Error deleting query:', error);
        showAlert('danger', 'Failed to delete query: ' + error.message);
    } finally {
        if (button) {
            setLoading(button, false);
        }
    }
}

function createAlert(event) {
    if (!currentQueryId) return;
    
    if (event) {
        const button = event.target.closest('button');
        setLoading(button, true);
    }
    
    sessionStorage.setItem('createAlertForQuery', currentQueryId);
    
    try {
    const modal = bootstrap.Modal.getInstance(document.getElementById('viewQueryModal'));
        if (modal) modal.hide();
    } catch (modalError) {
        console.warn('Modal error:', modalError);
    }
    
    window.location.href = "{{ url_for('alerts_page') }}";
} 

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchInput').addEventListener('input', filterQueries);
    document.getElementById('typeFilter').addEventListener('change', filterQueries);
    document.getElementById('sortBy').addEventListener('change', sortQueries);
    
    // Initialize CodeMirror
    if (document.getElementById('queryText')) {
        editor = CodeMirror.fromTextArea(document.getElementById('queryText'), {
            mode: 'text/x-sql',
            theme: 'monokai',
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            lineWrapping: true
        });
    }
});
</script>
{% endblock %}