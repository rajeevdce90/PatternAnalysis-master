{% extends 'base.html' %}

{% block head %}
<!-- Prism.js for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
<style>
    .loading {
        position: relative;
        pointer-events: none;
        opacity: 0.6;
    }
    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 1.5rem;
        height: 1.5rem;
        margin: -0.75rem 0 0 -0.75rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--olympic-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #alertContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }
    .alert-float {
        min-width: 300px;
        margin-bottom: 10px;
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
</style>
{% endblock %}

{% block content %}
<div id="alertContainer"></div>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="bi bi-file-text"></i> Reports
                    <small class="text-muted">Analysis Reports</small>
                </h2>
                <button class="btn btn-primary" onclick="window.location.href='{{ url_for('sql_query') }}';">
                    <i class="bi bi-plus-circle"></i> Create Report
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search reports...">
                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="scheduleFilter">
                <option value="">All Schedules</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="custom">Custom</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="formatFilter">
                <option value="">All Formats</option>
                <option value="pdf">PDF</option>
                <option value="excel">Excel</option>
                <option value="csv">CSV</option>
                <option value="json">JSON</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="sortBy">
                <option value="name">Sort by Name</option>
                <option value="created">Sort by Created Date</option>
                <option value="lastrun">Sort by Last Run</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Schedule</th>
                            <th>Format</th>
                            <th>Last Run</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        {% for report in reports %}
                        <tr data-report-id="{{ report.id }}">
                            <td>{{ report.name }}</td>
                            <td>{{ report.description }}</td>
                            <td>{{ report.report_schedule|default('On-Demand') }}</td>
                            <td>{{ report.report_format|default('PDF') }}</td>
                            <td>{{ report.last_run|default('Never') }}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewReport('{{ report.id }}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="runQuery('{{ report.id }}')">
                                        <i class="bi bi-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteReport('{{ report.id }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if not reports %}
            <div class="alert alert-info">No reports found. Create a report to generate analysis reports.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- View Report Modal -->
<div class="modal fade" id="viewReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" id="reportName" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="reportDescription" rows="2" readonly></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Query</label>
                    <pre><code id="reportQuery" class="language-sql line-numbers"></code></pre>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Schedule</label>
                        <input type="text" class="form-control" id="reportSchedule" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Format</label>
                        <input type="text" class="form-control" id="reportFormat" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Last Run</label>
                        <input type="text" class="form-control" id="reportLastRun" readonly>
                    </div>
                </div>
                <div id="reportOptions"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" onclick="deleteReport(currentReportId)">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="runQuery(currentReportId)">Run Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Prism.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/line-numbers/prism-line-numbers.min.js"></script>

<script>
let currentReportId = null;

function showAlert(type, message, duration = 5000) {
    const alertContainer = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-float alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 300);
    }, duration);
}

function setLoading(element, isLoading) {
    if (isLoading) {
        element.classList.add('loading');
        if (element.tagName === 'BUTTON') {
            element.disabled = true;
        }
    } else {
        element.classList.remove('loading');
        if (element.tagName === 'BUTTON') {
            element.disabled = false;
        }
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    filterReports();
}

function filterReports() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const scheduleFilter = document.getElementById('scheduleFilter').value;
    const formatFilter = document.getElementById('formatFilter').value;
    const rows = document.getElementById('reportsTableBody').getElementsByTagName('tr');

    for (let row of rows) {
        const name = row.cells[0].textContent.toLowerCase();
        const description = row.cells[1].textContent.toLowerCase();
        const schedule = row.cells[2].textContent.toLowerCase();
        const format = row.cells[3].textContent.toLowerCase();

        const matchesSearch = name.includes(searchTerm) || description.includes(searchTerm);
        const matchesSchedule = !scheduleFilter || schedule === scheduleFilter.toLowerCase();
        const matchesFormat = !formatFilter || format === formatFilter.toLowerCase();

        row.style.display = matchesSearch && matchesSchedule && matchesFormat ? '' : 'none';
    }
}

function sortReports() {
    const sortBy = document.getElementById('sortBy').value;
    const tbody = document.getElementById('reportsTableBody');
    const rows = Array.from(tbody.getElementsByTagName('tr'));

    rows.sort((a, b) => {
        let aValue, bValue;
        switch (sortBy) {
            case 'name':
                aValue = a.cells[0].textContent;
                bValue = b.cells[0].textContent;
                break;
            case 'created':
                aValue = a.dataset.createdAt || '';
                bValue = b.dataset.createdAt || '';
                break;
            case 'lastrun':
                aValue = a.cells[4].textContent;
                bValue = b.cells[4].textContent;
                // Handle "Never" as oldest
                if (aValue === 'Never') aValue = '1970-01-01';
                if (bValue === 'Never') bValue = '1970-01-01';
                break;
        }
        return aValue > bValue ? 1 : -1;
    });

    rows.forEach(row => tbody.appendChild(row));
}

async function viewReport(reportId) {
    const modal = document.getElementById('viewReportModal');
    setLoading(modal, true);
    currentReportId = reportId;
    
    try {
        const response = await fetch(`/api/queries/${reportId}`);
        if (!response.ok) throw new Error('Failed to fetch report details');
        
        const report = await response.json();
        document.getElementById('reportName').value = report.name;
        document.getElementById('reportDescription').value = report.description;
        document.getElementById('reportQuery').textContent = report.query;
        document.getElementById('reportSchedule').value = report.report_schedule || 'On-Demand';
        document.getElementById('reportFormat').value = report.report_format || 'PDF';
        document.getElementById('reportLastRun').value = report.last_run || 'Never';
        
        // Trigger Prism.js syntax highlighting
        Prism.highlightAll();
        
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
    } catch (error) {
        console.error('Error fetching report:', error);
        showAlert('danger', 'Failed to load report details');
    } finally {
        setLoading(modal, false);
    }
}

async function runQuery(reportId) {
    const button = event.target.closest('button');
    setLoading(button, true);
    
    try {
        const response = await fetch(`/api/queries/${reportId}/run`, { method: 'POST' });
        if (!response.ok) throw new Error('Failed to run report');
        
        const result = await response.json();
        if (result.redirect_url) {
            window.location.href = result.redirect_url;
        } else {
            showAlert('success', 'Report executed successfully');
        }
    } catch (error) {
        console.error('Error running report:', error);
        showAlert('danger', 'Failed to run report');
    } finally {
        setLoading(button, false);
    }
}

async function deleteReport(reportId) {
    if (!confirm('Are you sure you want to delete this report?')) return;
    
    const button = event.target.closest('button');
    setLoading(button, true);
    
    try {
        const response = await fetch(`/delete_query/${reportId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete report');
        
        // Close modal if open
        const modal = bootstrap.Modal.getInstance(document.getElementById('viewReportModal'));
        if (modal) modal.hide();
        
        // Remove row from table
        const row = document.querySelector(`tr[data-report-id="${reportId}"]`);
        if (row) {
            row.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => row.remove(), 300);
        }
        
        showAlert('success', 'Report deleted successfully');
    } catch (error) {
        console.error('Error deleting report:', error);
        showAlert('danger', 'Failed to delete report');
    } finally {
        setLoading(button, false);
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchInput').addEventListener('input', filterReports);
    document.getElementById('scheduleFilter').addEventListener('change', filterReports);
    document.getElementById('formatFilter').addEventListener('change', filterReports);
    document.getElementById('sortBy').addEventListener('change', sortReports);
});
</script>
{% endblock %} 