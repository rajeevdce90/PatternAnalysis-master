{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="content-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="bi bi-shield"></i> Detections
                <small class="text-muted">Security Event Detection</small>
            </h1>
            <button class="btn btn-primary" id="createDetectionBtn">
                <i class="bi bi-plus-circle"></i> Create Detection
            </button>
        </div>

        <!-- Detection Categories -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-shield-exclamation"></i> Security</h5>
                        <p class="card-text">Authentication, access control, and security policy violations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-exclamation-triangle"></i> System</h5>
                        <p class="card-text">System errors, performance issues, and resource utilization</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-graph-up"></i> Performance</h5>
                        <p class="card-text">Application performance, response times, and bottlenecks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-people"></i> User Activity</h5>
                        <p class="card-text">User behavior, session analysis, and activity patterns</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detection Rules Table -->
        <div class="table-responsive">
            <table class="table table-hover" id="detectionsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Last Modified</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Detection rules will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit Detection Modal -->
<div class="modal fade" id="detectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Detection Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="detectionForm">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="detectionName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="detectionCategory" required>
                            <option value="security">Security</option>
                            <option value="system">System</option>
                            <option value="performance">Performance</option>
                            <option value="user">User Activity</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="detectionDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Detection Logic</label>
                        <textarea class="form-control" id="detectionLogic" rows="5" required></textarea>
                        <div class="form-text">Enter SQL query or detection pattern</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Severity</label>
                        <select class="form-select" id="detectionSeverity" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDetectionBtn">Save Detection</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Load detections
    loadDetections();
    
    // Create Detection button
    $('#createDetectionBtn').on('click', function() {
        $('#detectionForm')[0].reset();
        $('#detectionModal').modal('show');
    });
    
    // Save Detection button
    $('#saveDetectionBtn').on('click', saveDetection);
});

function loadDetections() {
    $.ajax({
        url: '/api/alerts', // Endpoint to fetch alerts
        method: 'GET',
        success: function(data) {
            const $tableBody = $('#detectionsTable tbody');
            $tableBody.empty(); // Clear existing rows

            data.forEach(alert => {
                const row = `
                    <tr>
                        <td>${alert.name}</td>
                        <td>${alert.category || 'N/A'}</td>
                        <td>${alert.description}</td>
                        <td>${alert.status}</td>
                        <td>${alert.last_modified || 'N/A'}</td>
                        <td>
                            <!-- Add action buttons here -->
                        </td>
                    </tr>
                `;
                $tableBody.append(row);
            });
        },
        error: function(err) {
            console.error('Error loading detections:', err);
        }
    });
}

function saveDetection() {
    // TODO: Implement saving detection to backend
    // This is a placeholder that will be implemented later
}
</script>
{% endblock %} 