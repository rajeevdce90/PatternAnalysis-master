{% extends 'base.html' %}

{% block head %}
<!-- Prism.js for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
<style>
    .loading {
        position: relative;
        pointer-events: none;
        opacity: 0.6;
    }
    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 1.5rem;
        height: 1.5rem;
        margin: -0.75rem 0 0 -0.75rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--olympic-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #alertContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }
    .alert-float {
        min-width: 300px;
        margin-bottom: 10px;
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    .badge-severity-low {
        background-color: #28a745;
    }
    .badge-severity-medium {
        background-color: #ffc107;
        color: #212529;
    }
    .badge-severity-high {
        background-color: #fd7e14;
    }
    .badge-severity-critical {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div id="alertContainer"></div>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="bi bi-shield-exclamation"></i> Detections
                    <small class="text-muted">Security Event Detection</small>
                </h2>
                <button class="btn btn-primary" onclick="window.location.href='{{ url_for('sql_query') }}'">
                    <i class="bi bi-plus-circle"></i> Create Detection
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search detections...">
                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
                <option value="security">Security</option>
                <option value="system">System</option>
                <option value="performance">Performance</option>
                <option value="user">User Activity</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="severityFilter">
                <option value="">All Severities</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="sortBy">
                <option value="name">Sort by Name</option>
                <option value="created">Sort by Created Date</option>
                <option value="severity">Sort by Severity</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Severity</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="detectionsTableBody">
                        {% for alert in alerts %}
                        <tr data-alert-id="{{ alert.id }}">
                            <td>{{ alert.name }}</td>
                            <td>{{ alert.description }}</td>
                            <td>{{ alert.category|default('Security') }}</td>
                            <td><span class="badge bg-{{ alert.severity_class|default('danger') }}">{{ alert.severity|default('High') }}</span></td>
                            <td>{{ alert.created_at }}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetection('{{ alert.id }}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="runQuery('{{ alert.id }}')">
                                        <i class="bi bi-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDetection('{{ alert.id }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if not alerts %}
            <div class="alert alert-info">No detection rules found. Create a detection rule to monitor security events.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- View Detection Modal -->
<div class="modal fade" id="viewDetectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detection Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" id="detectionName" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="detectionDescription" rows="2" readonly></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Query</label>
                    <pre><code id="detectionQuery" class="language-sql line-numbers"></code></pre>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Threshold</label>
                        <input type="text" class="form-control" id="detectionThreshold" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Condition</label>
                        <input type="text" class="form-control" id="detectionCondition" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Frequency (min)</label>
                        <input type="text" class="form-control" id="detectionFrequency" readonly>
                    </div>
                </div>
                <div id="detectionOptions"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" onclick="deleteDetection(currentDetectionId)">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="runQuery(currentDetectionId)">Run Detection</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Prism.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/line-numbers/prism-line-numbers.min.js"></script>

<script>
let currentDetectionId = null;

function showAlert(type, message, duration = 5000) {
    const alertContainer = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-float alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 300);
    }, duration);
}

function setLoading(element, isLoading) {
    if (isLoading) {
        element.classList.add('loading');
        if (element.tagName === 'BUTTON') {
            element.disabled = true;
        }
    } else {
        element.classList.remove('loading');
        if (element.tagName === 'BUTTON') {
            element.disabled = false;
        }
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    filterDetections();
}

function filterDetections() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const severityFilter = document.getElementById('severityFilter').value;
    const rows = document.getElementById('detectionsTableBody').getElementsByTagName('tr');

    for (let row of rows) {
        const name = row.cells[0].textContent.toLowerCase();
        const description = row.cells[1].textContent.toLowerCase();
        const category = row.cells[2].textContent.toLowerCase();
        const severity = row.cells[3].textContent.toLowerCase();

        const matchesSearch = name.includes(searchTerm) || description.includes(searchTerm);
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesSeverity = !severityFilter || severity === severityFilter;

        row.style.display = matchesSearch && matchesCategory && matchesSeverity ? '' : 'none';
    }
}

function sortDetections() {
    const sortBy = document.getElementById('sortBy').value;
    const tbody = document.getElementById('detectionsTableBody');
    const rows = Array.from(tbody.getElementsByTagName('tr'));

    rows.sort((a, b) => {
        let aValue, bValue;
        switch (sortBy) {
            case 'name':
                aValue = a.cells[0].textContent;
                bValue = b.cells[0].textContent;
                break;
            case 'created':
                aValue = new Date(a.cells[4].textContent);
                bValue = new Date(b.cells[4].textContent);
                break;
            case 'severity':
                const severityOrder = { 'low': 0, 'medium': 1, 'high': 2, 'critical': 3 };
                aValue = severityOrder[a.cells[3].textContent.toLowerCase()] || 0;
                bValue = severityOrder[b.cells[3].textContent.toLowerCase()] || 0;
                break;
        }
        return aValue > bValue ? 1 : -1;
    });

    rows.forEach(row => tbody.appendChild(row));
}

async function viewDetection(alertId) {
    const modal = document.getElementById('viewDetectionModal');
    setLoading(modal, true);
    currentDetectionId = alertId;
    
    try {
        const response = await fetch(`/api/queries/${alertId}`);
        if (!response.ok) throw new Error('Failed to fetch detection details');
        
        const alert = await response.json();
        document.getElementById('detectionName').value = alert.name;
        document.getElementById('detectionDescription').value = alert.description;
        document.getElementById('detectionQuery').textContent = alert.query;
        document.getElementById('detectionThreshold').value = alert.threshold || 'N/A';
        document.getElementById('detectionCondition').value = alert.condition || 'N/A';
        document.getElementById('detectionFrequency').value = alert.frequency || 'N/A';
        
        // Trigger Prism.js syntax highlighting
        Prism.highlightAll();
        
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
    } catch (error) {
        console.error('Error fetching detection:', error);
        showAlert('danger', 'Failed to load detection details');
    } finally {
        setLoading(modal, false);
    }
}

async function runQuery(alertId) {
    const button = event.target.closest('button');
    setLoading(button, true);
    
    try {
        const response = await fetch(`/api/queries/${alertId}/run`, { method: 'POST' });
        if (!response.ok) throw new Error('Failed to run detection');
        
        const result = await response.json();
        if (result.redirect_url) {
            window.location.href = result.redirect_url;
        } else {
            showAlert('success', 'Detection executed successfully');
        }
    } catch (error) {
        console.error('Error running detection:', error);
        showAlert('danger', 'Failed to run detection');
    } finally {
        setLoading(button, false);
    }
}

async function deleteDetection(alertId) {
    if (!confirm('Are you sure you want to delete this detection?')) return;
    
    const button = event.target.closest('button');
    setLoading(button, true);
    
    try {
        const response = await fetch(`/delete_query/${alertId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete detection');
        
        // Close modal if open
        const modal = bootstrap.Modal.getInstance(document.getElementById('viewDetectionModal'));
        if (modal) modal.hide();
        
        // Remove row from table
        const row = document.querySelector(`tr[data-alert-id="${alertId}"]`);
        if (row) {
            row.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => row.remove(), 300);
        }
        
        showAlert('success', 'Detection deleted successfully');
    } catch (error) {
        console.error('Error deleting detection:', error);
        showAlert('danger', 'Failed to delete detection');
    } finally {
        setLoading(button, false);
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchInput').addEventListener('input', filterDetections);
    document.getElementById('categoryFilter').addEventListener('change', filterDetections);
    document.getElementById('severityFilter').addEventListener('change', filterDetections);
    document.getElementById('sortBy').addEventListener('change', sortDetections);
});
</script>
{% endblock %} 