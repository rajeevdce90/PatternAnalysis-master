{% extends "base.html" %}

{% block content %}
<style>
    .input-group {
        flex-wrap: nowrap;
    }
    
    .input-group select,
    .input-group input[type="text"] {
        min-width: 200px;
    }
    
    .input-group .form-select {
        flex: 1 1 auto;
    }
    
    .input-group .btn {
        flex: 0 0 auto;
    }
</style>

<div class="container-fluid">
    <div class="content-wrapper">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="bi bi-file-earmark-plus"></i> Add Data
                <small class="text-muted">Choose your data source</small>
            </h1>
            <a href="/search" class="btn btn-primary">
                <i class="bi bi-search"></i> Search Data
            </a>
        </div>
    
        <!-- Data Source Options (Tabs) -->
        <ul class="nav nav-tabs mb-3" id="addDataTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button" role="tab" aria-controls="upload-pane" aria-selected="true">
                    <i class="bi bi-upload"></i> File Upload
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="aws-tab" data-bs-toggle="tab" data-bs-target="#aws-pane" type="button" role="tab" aria-controls="aws-pane" aria-selected="false">
                    <i class="bi bi-cloud"></i> AWS CloudTrail
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rest-tab" data-bs-toggle="tab" data-bs-target="#rest-pane" type="button" role="tab" aria-controls="rest-pane" aria-selected="false">
                    <i class="bi bi-cloud-arrow-down"></i> REST API Collector
                </button>
            </li>
             <li class="nav-item" role="presentation">
                <button class="nav-link" id="syslog-tab" data-bs-toggle="tab" data-bs-target="#syslog-pane" type="button" role="tab" aria-controls="syslog-pane" aria-selected="false">
                    <i class="bi bi-reception-4"></i> Syslog Input
                </button>
            </li>
             <li class="nav-item" role="presentation">
                <button class="nav-link" id="hec-tab" data-bs-toggle="tab" data-bs-target="#hec-pane" type="button" role="tab" aria-controls="hec-pane" aria-selected="false">
                    <i class="bi bi-input-cursor-text"></i> HEC Input
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="db-tab" data-bs-toggle="tab" data-bs-target="#db-pane" type="button" role="tab" aria-controls="db-pane" aria-selected="false">
                    <i class="bi bi-server"></i> Database Connection
                </button>
            </li>
            <!-- Add more tabs for future options here -->
        </ul>

        <div class="tab-content" id="addDataTabContent">
            <!-- File Upload Pane -->
            <div class="tab-pane fade show active" id="upload-pane" role="tabpanel" aria-labelledby="upload-tab">
                <h4>Upload Log File</h4>
                <p>Upload your log file (CSV or JSON). The analysis workflow will start automatically.</p>
                <div class="workflow-container">
                    <div class="workflow-step active" id="step1">
                        <div class="step-content">
                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="targetIndex" class="form-label">Target Index</label>
                                    <input type="text" class="form-control" id="targetIndex" name="target_index" list="indexOptions" required>
                                    <datalist id="indexOptions">
                                        <option value="aws">AWS Logs</option>
                                        <option value="cloudtrail">CloudTrail</option>
                                        <option value="logs">General Logs</option>
                                        <option value="security_events">Security Events</option>
                                    </datalist>
                                    <div class="form-text">Enter the name of the index where data will be stored</div>
                                </div>
                                <div class="mb-3">
                                    <label for="datatype" class="form-label">Data Type</label>
                                    <input type="text" class="form-control" id="datatype" name="datatype" list="datatypeOptions" required>
                                    <datalist id="datatypeOptions">
                                        <option value="aws_logs">AWS Logs</option>
                                        <option value="cloud_logs">Cloud Logs</option>
                                        <option value="firewall_logs">Firewall Logs</option>
                                        <option value="application_logs">Application Logs</option>
                                        <option value="system_logs">System Logs</option>
                                    </datalist>
                                    <div class="form-text">Enter the type of data being uploaded</div>
                                </div>
                                <div class="mb-3">
                                    <label for="logFile" class="form-label">Log File</label>
                                    <input type="file" id="logFile" name="file" class="form-control" accept=".csv, .json" required>
                                </div>
                                <button type="submit" class="btn btn-primary" id="uploadBtn">Upload and Analyze</button>
                                <div class="spinner-border text-primary d-none" id="uploadSpinner" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </form>
                            <div id="uploadStatus" class="alert alert-info mt-3" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="workflow-step" id="step2" style="display: none;">
                        <div class="d-flex align-items-center mb-3">
                <div class="step-number">2</div>
                            <div class="step-title">Select Column for Pattern Analysis</div>
            </div>
            <div class="step-content">
                            <p>Choose which column contains the log messages or patterns.</p>
                            <select id="columnSelect" class="form-select mb-3"></select>
                            <button id="generatePatternsBtn" class="btn btn-primary">Generate Patterns</button>
                </div>
            </div>
                    <div class="workflow-step" id="step3" style="display: none;">
                         <div class="d-flex align-items-center mb-3">
                <div class="step-number">3</div>
                            <div class="step-title">Review Events</div>
            </div>
            <div class="step-content">
                            <p>Review the parsed events from your log file.</p>
                            <div class="table-responsive events-container">
                                <table class="table table-sm table-hover events-table" id="eventsTable">
                                    <thead id="eventsHeader"></thead>
                                    <tbody id="eventsBody"></tbody>
                                </table>
            </div>
                            <div class="pagination mt-3" id="eventsPagination"></div>
        </div>
                    </div>
                    <div class="workflow-step" id="step4" style="display: none;">
                         <div class="d-flex align-items-center mb-3">
                <div class="step-number">4</div>
                            <div class="step-title">Analyze Patterns</div>
            </div>
            <div class="step-content">
                             <p>Discovered patterns:</p>
                            <div id="patternsContainer"></div>
                            <button id="generateRegexBtn" class="btn btn-primary mt-3" style="display: none;">Generate Regex Patterns</button>
                </div>
            </div>
                    </div>
                </div>

            <!-- AWS CloudTrail Pane -->
            <div class="tab-pane fade" id="aws-pane" role="tabpanel" aria-labelledby="aws-tab">
                <h4>Upload AWS CloudTrail Data</h4>
                <p>Directly upload AWS CloudTrail data to the OpenSearch index.</p>
                <form id="awsUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="awsTargetIndex" class="form-label">Target Index</label>
                        <input type="text" class="form-control" id="awsTargetIndex" name="target_index" value="aws" readonly>
                        <div class="form-text">Index name for AWS CloudTrail data</div>
                    </div>
                    <div class="mb-3">
                        <label for="awsDatatype" class="form-label">Data Type</label>
                        <input type="text" class="form-control" id="awsDatatype" name="datatype" value="aws_logs" readonly>
                        <div class="form-text">Type of AWS data being uploaded</div>
                    </div>
                    <div class="mb-3">
                        <label for="awsLogFile" class="form-label">CloudTrail JSON File</label>
                        <input type="file" id="awsLogFile" name="file" class="form-control" accept=".json" required>
                        <div class="form-text">Select a CloudTrail JSON file</div>
                    </div>
                    <button type="button" class="btn btn-primary" id="awsUploadBtn">
                        Upload CloudTrail Data
                    </button>
                    <div class="spinner-border text-primary d-none" id="awsUploadSpinner" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </form>
                <div id="awsUploadStatus" class="alert mt-3" style="display: none;"></div>
                <div id="awsQueryOptions" class="mt-3"></div>
            </div>

            <!-- REST API Collector Pane -->
            <div class="tab-pane fade" id="rest-pane" role="tabpanel" aria-labelledby="rest-tab">
                <h4>Configure REST API Collector</h4>
                <p>Set up a collector to periodically fetch data from a REST API endpoint.</p>
                <form id="restCollectorForm">
                    <div class="mb-3">
                        <label for="restTargetIndex" class="form-label">Target Index</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="restTargetIndex" required placeholder="Enter index name">
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#newIndexModal">
                                <i class="bi bi-plus-lg"></i> New Index
                            </button>
                        </div>
                        <div class="form-text">Enter the name of the index where data will be stored</div>
                    </div>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                             <label for="apiMethod" class="form-label">HTTP Method</label>
                             <select id="apiMethod" class="form-select">
                                 <option value="GET" selected>GET</option>
                                 <option value="POST">POST</option>
                             </select>
                    </div>
                         <div class="col-md-6 mb-3">
                            <label for="pollInterval" class="form-label">Polling Interval (seconds)</label>
                            <input type="number" class="form-control" id="pollInterval" value="300" min="60" required>
                             <small class="text-muted">Minimum 60 seconds</small>
                </div>
            </div>
                    <div class="mb-3">
                        <label for="apiHeaders" class="form-label">Headers (JSON Format, Optional)</label>
                        <textarea class="form-control" id="apiHeaders" rows="3" placeholder='{ "Content-Type": "application/json", "Authorization": "Bearer YOUR_TOKEN" }'></textarea>
        </div>
                    <div class="mb-3" id="apiBodyContainer" style="display: none;">
                        <label for="apiBody" class="form-label">Request Body (JSON Format, Optional)</label>
                        <textarea class="form-control" id="apiBody" rows="4" placeholder='{ "parameter": "value" }'></textarea>
            </div>
                    <div class="mb-3">
                        <label for="restDatatype" class="form-label">Data Type</label>
                        <input type="text" class="form-control" id="restDatatype" required 
                               placeholder="e.g., api_metrics, external_events">
                        <div class="form-text">A unique identifier for this type of data</div>
                    </div>
                     <!-- Future: Authentication options (e.g., Basic, Bearer Token) -->
                    <button type="button" class="btn btn-primary" id="startCollectorBtn">
                        <i class="bi bi-play-circle"></i> Start Collector
                    </button>
                    <div id="collectorStatus" class="mt-3"></div>
                </form>
            </div>

            <!-- Syslog Input Pane -->
            <div class="tab-pane fade" id="syslog-pane" role="tabpanel" aria-labelledby="syslog-tab">
                <h4>Configure Syslog Input</h4>
                <p>Set up a listener to receive Syslog messages directly.</p>
                <form id="syslogForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="syslogTargetIndex" class="form-label">Target Index</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="syslogTargetIndex" required placeholder="Enter index name">
                                <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#newIndexModal">
                                    <i class="bi bi-plus-lg"></i> New Index
                                </button>
                            </div>
                            <div class="form-text">Enter the name of the index where data will be stored</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="syslogPort" class="form-label">Listen Port</label>
                            <input type="number" class="form-control" id="syslogPort" value="514" min="1" max="65535" required>
                            <small class="text-muted">Standard Syslog port is 514.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="syslogProtocol" class="form-label">Protocol</label>
                            <select id="syslogProtocol" class="form-select">
                                <option value="UDP" selected>UDP</option>
                                <option value="TCP">TCP</option>
                            </select>
                             <small class="text-muted">Ensure your devices send logs using this protocol.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="syslogDatatype" class="form-label">Data Type</label>
                        <input type="text" class="form-control" id="syslogDatatype" required 
                               placeholder="e.g., syslog_events, network_logs">
                        <div class="form-text">A unique identifier for this type of data</div>
                    </div>
                    <!-- Future: Options for TLS, message format parsing -->
                    <button type="button" class="btn btn-primary" id="startSyslogBtn">
                        <i class="bi bi-play-circle"></i> Start Syslog Listener
                    </button>
                    <div id="syslogStatus" class="mt-3"></div>
                </form>
            </div>

            <!-- HEC Input Pane -->
            <div class="tab-pane fade" id="hec-pane" role="tabpanel" aria-labelledby="hec-tab">
                <h4>Configure HEC (HTTP Event Collector) Input</h4>
                <p>Set up an endpoint to receive data via HTTP POST requests, similar to Splunk HEC.</p>
                <form id="hecForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="hecTargetIndex" class="form-label">Target Index</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="hecTargetIndex" required placeholder="Enter index name">
                                <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#newIndexModal">
                                    <i class="bi bi-plus-lg"></i> New Index
                                </button>
                            </div>
                            <div class="form-text">Enter the name of the index where data will be stored</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="hecPort" class="form-label">Listen Port</label>
                            <input type="number" class="form-control" id="hecPort" value="8088" min="1" max="65535" required>
                            <small class="text-muted">Standard HEC port is 8088.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                             <div class="form-check mt-4 pt-2">
                                <input class="form-check-input" type="checkbox" id="hecUseHttps">
                                <label class="form-check-label" for="hecUseHttps">
                                    Enable HTTPS (Requires server-side certificate configuration)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="hecDatatype" class="form-label">Data Type</label>
                        <input type="text" class="form-control" id="hecDatatype" required 
                               placeholder="e.g., application_metrics, custom_events">
                        <div class="form-text">A unique identifier for this type of data</div>
                    </div>
                    <div class="mb-3">
                        <label for="hecToken" class="form-label">HEC Token</label>
                        <div class="input-group">
                             <input type="text" class="form-control" id="hecToken" placeholder="Generate a token" readonly>
                             <button class="btn btn-outline-secondary" type="button" id="generateHecTokenBtn">Generate</button>
                        </div>
                         <small class="text-muted">Clients must include this token in the 'Authorization: Splunk TOKEN_VALUE' header.</small>
                    </div>
                    
                    <!-- Future: Options for index target, source type mapping -->
                    <button type="button" class="btn btn-primary" id="startHecBtn">
                        <i class="bi bi-play-circle"></i> Start HEC Listener
                    </button>
                     <div id="hecStatus" class="mt-3"></div>
                </form>
            </div>

            <!-- Database Connection Pane -->
            <div class="tab-pane fade" id="db-pane" role="tabpanel" aria-labelledby="db-tab">
                <h4>Connect to Database</h4>
                <p>Configure a connection to pull data directly from a database.</p>
                <form id="dbConnectionForm">
                     <div class="mb-3">
                        <label for="dbTargetIndex" class="form-label">Target Index</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="dbTargetIndex" required placeholder="Enter index name">
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#newIndexModal">
                                <i class="bi bi-plus-lg"></i> New Index
                            </button>
                        </div>
                        <div class="form-text">Enter the name of the index where data will be stored</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dbType" class="form-label">Database Type</label>
                            <select id="dbType" class="form-select" required>
                                <option value="" disabled selected>Select Type...</option>
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="sqlserver">SQL Server</option>
                                <option value="oracle">Oracle</option> 
                                <!-- Add more DB types as needed -->
                            </select>
                        </div>
                         <div class="col-md-6 mb-3">
                             <label for="dbHost" class="form-label">Host</label>
                            <input type="text" class="form-control" id="dbHost" placeholder="db.example.com" required>
                        </div>
                    </div>
                     <div class="row">
                         <div class="col-md-6 mb-3">
                            <label for="dbPort" class="form-label">Port</label>
                            <input type="number" class="form-control" id="dbPort" placeholder="e.g., 5432" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dbName" class="form-label">Database Name</label>
                            <input type="text" class="form-control" id="dbName" placeholder="e.g., logs_db" required>
                        </div>
                    </div>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dbUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="dbUsername" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="dbPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="dbPassword" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="dbDatatype" class="form-label">Data Type</label>
                        <input type="text" class="form-control" id="dbDatatype" required 
                               placeholder="e.g., database_logs, sql_events">
                        <div class="form-text">A unique identifier for this type of data</div>
                    </div>
                     <!-- Future: SSL options, connection pooling -->
                     <button type="button" class="btn btn-secondary" id="testDbConnectionBtn">
                        <i class="bi bi-plug"></i> Test Connection
                    </button>
                    <button type="button" class="btn btn-primary ms-2" id="saveDbConnectionBtn">
                        <i class="bi bi-save"></i> Save Connection
                    </button>
                     <div id="dbConnectionStatus" class="mt-3"></div>
                </form>
                
                <!-- Area to show saved DB connections (future enhancement) -->
                 <hr class="my-4">
                 <h5>Saved Connections</h5>
                 <div id="savedDbConnectionsList"></div>
            </div>
            <!-- Add more tab panes for future options here -->
        </div>
    </div>
    </div>

<!-- New Index Modal -->
<div class="modal fade" id="newIndexModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Index</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newIndexForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="indexName" class="form-label">Index Name</label>
                        <input type="text" class="form-control" id="indexName" required 
                               pattern="[a-z0-9-]+" placeholder="lowercase-letters-numbers-only">
                        <div class="form-text">Use lowercase letters, numbers, and hyphens only</div>
                    </div>
                    <div class="mb-3">
                        <label for="indexSettings" class="form-label">Index Settings (Optional)</label>
                        <textarea class="form-control" id="indexSettings" rows="4" 
                                placeholder='{"settings": {"number_of_shards": 1, "number_of_replicas": 1}}'></textarea>
                        <div class="form-text">JSON format. Leave empty for default settings</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Index</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- After upload results -->
<div id="queryOptions" class="mt-3"></div>

{% endblock %}

{% block scripts %}
<!-- Existing scripts for file upload workflow -->
    <script>
// Global variables for file upload workflow
let events = [];
        let columns = [];
let totalEvents = 0;
let currentPage = 1;
let itemsPerPage = 10;
let patterns = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing event handlers');
    
    // Regular file upload form handling
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadFile();
        });
    }
    
    // AWS CloudTrail upload button click handler
    const awsUploadBtn = document.getElementById('awsUploadBtn');
    if (awsUploadBtn) {
        console.log('AWS upload button found, adding click handler');
        awsUploadBtn.addEventListener('click', function() {
            console.log('AWS upload button clicked');
            uploadAwsCloudTrail();
        });
    } else {
        console.error('AWS upload button not found in DOM');
    }
    
    // Method selector for REST API
    const apiMethod = document.getElementById('apiMethod');
    if (apiMethod) {
        apiMethod.addEventListener('change', function() {
            const bodyContainer = document.getElementById('apiBodyContainer');
            if (bodyContainer) {
                bodyContainer.style.display = this.value === 'POST' ? 'block' : 'none';
            }
        });
    }
    
    // Load indices for all dropdowns on page load - REMOVED
    // loadIndices('targetIndex');
    // loadIndices('restTargetIndex');
    // loadIndices('syslogTargetIndex');
    
    // Add click handlers for refresh buttons - REMOVED
    // document.getElementById('refreshIndices').addEventListener('click', function() {
    //     loadIndices('targetIndex');
    // });
    
    // REST API Collector form handler
    document.getElementById('restCollectorForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const targetIndex = document.getElementById('restTargetIndex').value;
        if (!targetIndex) {
            showToast('Please enter a target index', 'error');
            return;
        }
        startRestCollector(targetIndex);
    });
    
    // Syslog form handler
    document.getElementById('syslogForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const targetIndex = document.getElementById('syslogTargetIndex').value;
        if (!targetIndex) {
            showToast('Please select a target index', 'error');
            return;
        }
        startSyslogListener(targetIndex);
    });
    
    // HEC form handler
    document.getElementById('hecForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const targetIndex = document.getElementById('hecTargetIndex').value;
        if (!targetIndex) {
            showToast('Please select a target index', 'error');
            return;
        }
        startHecListener(targetIndex);
    });
    
    // Database Connection form handler
    document.getElementById('dbConnectionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const targetIndex = document.getElementById('dbTargetIndex').value;
        if (!targetIndex) {
            showToast('Please select a target index', 'error');
            return;
        }
        saveDbConnection(targetIndex);
    });
    
    // Generate patterns button
    document.getElementById('generatePatternsBtn').addEventListener('click', function() {
        generatePatterns();
    });
    
    // Initially hide workflow steps 2-4
    // Handled by style="display: none;" inline now
    
    // REST API Collector specific logic
    const apiMethodSelect = document.getElementById('apiMethod');
    const apiBodyContainer = document.getElementById('apiBodyContainer');
    
    apiMethodSelect.addEventListener('change', function() {
        apiBodyContainer.style.display = this.value === 'POST' ? 'block' : 'none';
    });
    
    document.getElementById('startCollectorBtn').addEventListener('click', function() {
        startRestCollector();
    });

    // Syslog Listener button
    document.getElementById('startSyslogBtn').addEventListener('click', function() {
        startSyslogListener();
    });

    // HEC Listener buttons
    document.getElementById('startHecBtn').addEventListener('click', function() {
        startHecListener();
    });
    document.getElementById('generateHecTokenBtn').addEventListener('click', function() {
        generateHecToken();
    });

    // Database Connection buttons
    document.getElementById('testDbConnectionBtn').addEventListener('click', function() {
        testDbConnection();
    });
    document.getElementById('saveDbConnectionBtn').addEventListener('click', function() {
        saveDbConnection();
    });

    // New index form submission
    document.getElementById('newIndexForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('indexName').value;
        let settings = {};
        
        const settingsText = document.getElementById('indexSettings').value;
        if (settingsText.trim()) {
            try {
                settings = JSON.parse(settingsText);
            } catch (error) {
                showToast('Invalid JSON in settings', 'error');
                return;
            }
        }
        
        const success = await createIndex(name, settings);
        if (success) {
            bootstrap.Modal.getInstance(document.getElementById('newIndexModal')).hide();
            document.getElementById('newIndexForm').reset();
        }
    });

    // Handle index selection - REMOVED
    // document.getElementById('targetIndexSelect').addEventListener('change', function() {
    //     handleIndexSelection(this);
    // });
    
    // Back button for manual entry - REMOVED
    // document.getElementById('backToSelect').addEventListener('click', function() {
    //     document.getElementById('indexSelectContainer').style.display = 'block';
    //     document.getElementById('indexManualContainer').style.display = 'none';
    //     document.getElementById('targetIndexSelect').value = '';
    // });

    // Populate predefined index options
    const indexNameInput = document.getElementById('targetIndex');
    const predefinedIndices = ['aws', 'cloudtrail', 'logs', 'security_events'];
    
    predefinedIndices.forEach(index => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = index;
        if (indexNameInput.tagName === 'SELECT') {
            indexNameInput.appendChild(option);
        } else if (indexNameInput.tagName === 'INPUT' && indexNameInput.getAttribute('list')) {
            // For datalist implementation
            const dataList = document.getElementById(indexNameInput.getAttribute('list'));
            if (dataList) {
                const optionEl = document.createElement('option');
                optionEl.value = index;
                dataList.appendChild(optionEl);
            }
        }
    });
    
    // Create datalist for index name input if it's a text input
    if (indexNameInput.tagName === 'INPUT' && !indexNameInput.getAttribute('list')) {
        const dataListId = 'indexNameList';
        indexNameInput.setAttribute('list', dataListId);
        
        const dataList = document.createElement('datalist');
        dataList.id = dataListId;
        
        predefinedIndices.forEach(index => {
            const option = document.createElement('option');
            option.value = index;
            dataList.appendChild(option);
        });
        
        indexNameInput.parentNode.appendChild(dataList);
    }
});

// Function handleIndexSelection - REMOVED
// function handleIndexSelection(selectElement) {
//     if (selectElement.value === 'manual') {
//         document.getElementById('indexSelectContainer').style.display = 'none';
//         document.getElementById('indexManualContainer').style.display = 'block';
//         document.getElementById('targetIndex').focus();
//     }
// }

// Update loadIndices function - REMOVED
// async function loadIndices() {
//     try {
//         const response = await fetch('/api/admin/indices');
//         if (!response.ok) throw new Error('Failed to fetch indices');
//         
//         const data = await response.json();
//         const indexSelect = document.getElementById('targetIndexSelect');
//         
//         // Clear existing options except the manual entry option
//         indexSelect.innerHTML = `
//             <option value="">Select an index...</option>
//             <option value="manual">Enter manually...</option>
//         `;
//         
//         // Add new options
//         data.indices.forEach(index => {
//             const option = document.createElement('option');
//             option.value = index.name;
//             option.textContent = index.name;
//             indexSelect.appendChild(option);
//         });
//     } catch (error) {
//         console.error('Error loading indices:', error);
//         showToast('Failed to load indices', 'error');
//     }
// }

// Function to handle file upload
function uploadFile() {
    console.log("Upload function called"); // Debug logging
    const fileInput = document.getElementById('logFile');
    const indexInput = document.getElementById('targetIndex');
    const datatype = document.getElementById('datatype').value;
    
    const targetIndex = indexInput.value.trim();
    
    if (!targetIndex) {
        showAlert('warning', 'Please enter an index name');
        return;
    }
    
    if (!fileInput.files[0]) {
        showAlert('warning', 'Please select a file to upload');
        return;
    }
    
    if (!datatype) {
        showAlert('warning', 'Please enter a data type');
        return;
    }
    
    // Security: Client-side file size validation
    const maxSize = 50 * 1024 * 1024; // 50MB in bytes
    if (fileInput.files[0].size > maxSize) {
        showAlert('warning', `File exceeds maximum size of ${(maxSize / (1024 * 1024)).toFixed(1)}MB`);
        return;
    }
    
    // Security: Client-side file type validation
    const allowedExtensions = ['.json', '.csv'];
    const fileName = fileInput.files[0].name;
    const fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
    
    if (!allowedExtensions.includes(fileExt)) {
        showAlert('warning', `Unsupported file type. Allowed extensions: ${allowedExtensions.join(', ')}`);
        return;
    }
    
    // Show upload status as loading
    const uploadStatus = document.getElementById('uploadStatus');
    uploadStatus.innerHTML = '<div class="spinner-border text-primary" role="status"></div> Uploading file...';
    uploadStatus.style.display = 'block';
    uploadStatus.className = 'alert alert-info mt-3';
    
    // Disable the submit button during upload
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) submitBtn.disabled = true;
    
    console.log("Creating FormData"); // Debug logging
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('target_index', targetIndex);
    formData.append('datatype', datatype);
    
    console.log("Sending fetch request to /upload"); // Debug logging
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log("Response received:", response.status); // Debug logging
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || `HTTP error ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log("Response data:", data); // Debug logging
        
        // Re-enable the submit button
        if (submitBtn) submitBtn.disabled = false;
        
        if (data.success) {
            let message = `Success! Processed ${data.total_events} events.`;
            if (data.indexed) {
                message += ` Data has been indexed to "${targetIndex}".`;
            }
            uploadStatus.className = 'alert alert-success mt-3';
            uploadStatus.textContent = message;
            
            // Reset file input after successful upload
            fileInput.value = '';
            
            // Update the UI with the loaded data
            displayUploadResults(data);
        } else {
            uploadStatus.className = 'alert alert-danger mt-3';
            uploadStatus.textContent = 'Error: ' + data.error;
        }
    })
    .catch(error => {
        console.error("Fetch error:", error); // Debug logging
        
        // Re-enable the submit button
        if (submitBtn) submitBtn.disabled = false;
        
        uploadStatus.className = 'alert alert-danger mt-3';
        uploadStatus.textContent = 'Error: ' + error.message;
    });
}

function showMessage(message, type, element) {
    element.textContent = message;
    element.className = `alert alert-${type} mt-3`;
    element.style.display = 'block';
}

function populateColumnSelect(columns) {
            const select = document.getElementById('columnSelect');
    select.innerHTML = '<option value="">Select a column</option>';
    columns.forEach(column => {
                const option = document.createElement('option');
        option.value = column.name;
        option.textContent = `${column.name} (${column.type})`;
                select.appendChild(option);
            });
        }

function showEventsPage(filteredEvents) {
    const headerRow = document.getElementById('eventsHeader');
    const tableBody = document.getElementById('eventsBody');
    headerRow.innerHTML = '';
    tableBody.innerHTML = '';

    if (columns.length > 0) {
        columns.forEach(column => {
            const th = document.createElement('th');
            th.textContent = column.name;
            headerRow.appendChild(th);
        });
    }

    const start = (currentPage - 1) * itemsPerPage;
    const end = Math.min(start + itemsPerPage, filteredEvents.length);
    
    for (let i = start; i < end; i++) {
        const event = filteredEvents[i];
        const row = document.createElement('tr');
        columns.forEach(column => {
            const td = document.createElement('td');
            td.textContent = event[column.name] !== undefined ? event[column.name] : '';
            row.appendChild(td);
        });
        tableBody.appendChild(row);
    }
    createPagination(Math.ceil(filteredEvents.length / itemsPerPage), filteredEvents);
}

function createPagination(totalPages, dataSet) {
    const paginationDiv = document.getElementById('eventsPagination');
    paginationDiv.innerHTML = '';
    if (totalPages <= 1) return; // No pagination if only one page

    const createPageLink = (pageNum, text, isDisabled = false, isActive = false) => {
        const li = document.createElement('li');
        li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = text;
        if (!isDisabled) {
            a.onclick = (e) => {
                e.preventDefault();
                currentPage = pageNum;
                showEventsPage(dataSet);
            };
        }
        li.appendChild(a);
        return li;
    };

    const ul = document.createElement('ul');
    ul.className = 'pagination justify-content-center';

    ul.appendChild(createPageLink(currentPage - 1, 'Previous', currentPage === 1));

    // Simplified pagination links (adjust as needed for more complex scenarios)
    for (let i = 1; i <= totalPages; i++) {
         if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            ul.appendChild(createPageLink(i, i.toString(), false, i === currentPage));
        } else if (i === currentPage - 2 || i === currentPage + 2) {
             const li = document.createElement('li');
             li.className = 'page-item disabled';
             li.innerHTML = '<span class="page-link">...</span>';
             ul.appendChild(li);
        }
    }

    ul.appendChild(createPageLink(currentPage + 1, 'Next', currentPage === totalPages));
    paginationDiv.appendChild(ul);
}

function generatePatterns() {
    const selectedColumn = document.getElementById('columnSelect').value;
    const uploadStatusDiv = document.getElementById('uploadStatus'); // Use upload status for messages

    if (!selectedColumn) {
        showMessage('Please select a column first.', 'warning', uploadStatusDiv);
        return;
    }

    showMessage('Generating patterns...', 'info', uploadStatusDiv);

    fetch('/generate_patterns', {
                    method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ column: selectedColumn })
                })
                .then(response => response.json())
                .then(data => {
        if (data.success) {
            patterns = data.patterns;
            displayPatterns(patterns);
            showMessage('Patterns generated successfully.', 'success', uploadStatusDiv);
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step4').style.display = 'block';
            document.getElementById('step4').classList.add('active');
             document.getElementById('generateRegexBtn').style.display = 'block'; // Show regex button
        } else {
            showMessage('Error: ' + data.error, 'danger', uploadStatusDiv);
        }
                })
                .catch(error => {
        showMessage('Error: ' + error.message, 'danger', uploadStatusDiv);
    });
}

function displayPatterns(patternsData) {
    const container = document.getElementById('patternsContainer');
    container.innerHTML = ''; // Clear previous patterns
    if (!patternsData || patternsData.length === 0) {
        container.innerHTML = '<p>No patterns found or generated.</p>';
                return;
            }
            
    const list = document.createElement('ul');
    list.className = 'list-group';
    patternsData.forEach((p, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerHTML = `
            <div><strong>Pattern ${index + 1}:</strong></div>
            <pre class="mb-0">${p.pattern || 'N/A'}</pre>
            <small class="text-muted">Example: ${p.example || 'N/A'}</small>
        `;
        list.appendChild(li);
    });
    container.appendChild(list);
}

// Placeholder for future generateRegex function
// document.getElementById('generateRegexBtn').addEventListener('click', generateRegex);
// function generateRegex() { console.log("Generate Regex called"); /* TODO */ }

// --- REST API Collector Functions --- 

function startRestCollector(targetIndex) {
    const apiUrl = document.getElementById('apiUrl').value;
    const apiMethod = document.getElementById('apiMethod').value;
    const pollInterval = document.getElementById('pollInterval').value;
    const apiHeaders = document.getElementById('apiHeaders').value;
    const apiBody = document.getElementById('apiBody').value;
    const datatype = document.getElementById('restDatatype').value;
    const collectorStatusDiv = document.getElementById('collectorStatus');

    if (!apiUrl || !pollInterval || !datatype) {
        showMessage('API URL, Polling Interval, and Data Type are required.', 'warning', collectorStatusDiv);
        return;
    }

    let headers = {};
    try {
        headers = apiHeaders ? JSON.parse(apiHeaders) : {};
    } catch (e) {
        showMessage('Invalid JSON in Headers field.', 'danger', collectorStatusDiv);
        return;
    }

    let body = null;
    if (apiMethod === 'POST' && apiBody) {
        try {
            body = JSON.parse(apiBody);
        } catch (e) {
            showMessage('Invalid JSON in Request Body field.', 'danger', collectorStatusDiv);
            return;
        }
    }

    const collectorConfig = {
        url: apiUrl,
        method: apiMethod,
        interval: parseInt(pollInterval, 10),
        headers: headers,
        body: body,
        target_index: targetIndex,
        datatype: datatype
    };

    showMessage('Starting REST API collector...', 'info', collectorStatusDiv);

    // TODO: Replace with actual API call to backend to start the collector
    console.log("Collector Config:", collectorConfig);
    // Simulating success/failure
    setTimeout(() => {
         // Replace with actual response check
         const success = Math.random() > 0.3; // Simulate success/failure
         if (success) {
            showMessage('REST API collector started successfully.', 'success', collectorStatusDiv);
            // Optionally clear the form or disable button
         } else {
             showMessage('Failed to start REST API collector. Check backend logs.', 'danger', collectorStatusDiv);
         }
     }, 1500); 
    
    // fetch('/api/collectors/rest', { // Example future endpoint
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify(collectorConfig)
    // })
    // .then(response => response.json())
    // .then(data => {
    //     if (data.success) {
    //         showMessage('REST API collector started successfully.', 'success', collectorStatusDiv);
    //     } else {
    //         showMessage('Error: ' + data.error, 'danger', collectorStatusDiv);
    //     }
    // })
    // .catch(error => {
    //     showMessage('Error: ' + error.message, 'danger', collectorStatusDiv);
    // });
}

// --- Syslog Input Functions --- 
function startSyslogListener(targetIndex) {
    const port = document.getElementById('syslogPort').value;
    const protocol = document.getElementById('syslogProtocol').value;
    const datatype = document.getElementById('syslogDatatype').value;
    const syslogStatusDiv = document.getElementById('syslogStatus');

    if (!port || !datatype) {
        showMessage('Syslog Port and Data Type are required.', 'warning', syslogStatusDiv);
        return;
    }

    const syslogConfig = {
        port: parseInt(port, 10),
        protocol: protocol,
        target_index: targetIndex,
        datatype: datatype
    };

    showMessage('Starting Syslog listener...', 'info', syslogStatusDiv);

    // TODO: Replace with actual API call to backend to start the listener
    console.log("Syslog Config:", syslogConfig);
    // Simulating success/failure
    setTimeout(() => {
         // Replace with actual response check
         const success = Math.random() > 0.3; // Simulate success/failure
         if (success) {
            showMessage(`Syslog listener started successfully on ${protocol} port ${port}.`, 'success', syslogStatusDiv);
            // Optionally disable button
         } else {
             showMessage('Failed to start Syslog listener. Check backend logs.', 'danger', syslogStatusDiv);
         }
     }, 1500);
     
    // fetch('/api/listeners/syslog', { // Example future endpoint
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify(syslogConfig)
    // })
    // .then(response => response.json())
    // .then(data => { // ... handle response ... })
    // .catch(error => { // ... handle error ... });
}

// --- HEC Input Functions --- 
function startHecListener(targetIndex) {
    const port = document.getElementById('hecPort').value;
    const useHttps = document.getElementById('hecUseHttps').checked;
    const token = document.getElementById('hecToken').value;
    const datatype = document.getElementById('hecDatatype').value;
    const hecStatusDiv = document.getElementById('hecStatus');

    if (!port || !datatype) {
        showMessage('HEC Port and Data Type are required.', 'warning', hecStatusDiv);
        return;
    }
     if (!token) {
        showMessage('HEC Token must be generated first.', 'warning', hecStatusDiv);
        return;
    }

    const hecConfig = {
        port: parseInt(port, 10),
        use_https: useHttps,
        token: token,
        target_index: targetIndex,
        datatype: datatype
    };

    showMessage('Starting HEC listener...', 'info', hecStatusDiv);

    // TODO: Replace with actual API call to backend to start the listener
    console.log("HEC Config:", hecConfig);
    // Simulating success/failure
    setTimeout(() => {
         const success = Math.random() > 0.3; 
         if (success) {
            showMessage(`HEC listener started successfully on port ${port} (${useHttps ? 'HTTPS' : 'HTTP'}).`, 'success', hecStatusDiv);
         } else {
             showMessage('Failed to start HEC listener. Check backend logs.', 'danger', hecStatusDiv);
         }
     }, 1500);
     
    // fetch('/api/listeners/hec', { ... });
}

function generateHecToken() {
    const tokenInput = document.getElementById('hecToken');
    const hecStatusDiv = document.getElementById('hecStatus');
    showMessage('Generating HEC token...', 'info', hecStatusDiv);

    // TODO: Replace with actual API call to backend to generate/retrieve a secure token
    // For now, generating a simple UUID as a placeholder
    const placeholderToken = crypto.randomUUID(); 
    tokenInput.value = placeholderToken;
    showMessage('Placeholder token generated. Use backend for secure tokens.', 'success', hecStatusDiv);
    
    // fetch('/api/hec/token', { method: 'POST' })
    // .then(response => response.json())
    // .then(data => {
    //     if (data.success && data.token) {
    //         tokenInput.value = data.token;
    //         showMessage('HEC token generated/retrieved successfully.', 'success', hecStatusDiv);
    //     } else {
    //         showMessage('Failed to generate HEC token: ' + (data.error || 'Unknown error'), 'danger', hecStatusDiv);
    //     }
    // })
    // .catch(error => {
    //    showMessage('Error generating HEC token: ' + error.message, 'danger', hecStatusDiv);
    // });
}

// --- Database Connection Functions --- 
function testDbConnection() {
    const dbConfig = getDbFormData();
    const dbStatusDiv = document.getElementById('dbConnectionStatus');
    
    if (!dbConfig) return; // Validation failed

    showMessage('Testing database connection...', 'info', dbStatusDiv);

    // TODO: Replace with actual API call to backend to test connection
    console.log("DB Test Config:", dbConfig);
    // Simulating success/failure
    setTimeout(() => {
         const success = Math.random() > 0.3; 
         if (success) {
            showMessage(`Database connection to ${dbConfig.name} successful.`, 'success', dbStatusDiv);
         } else {
             showMessage('Failed to connect to database. Check details and network access.', 'danger', dbStatusDiv);
         }
     }, 1500);
     
    // fetch('/api/connections/db/test', { method: 'POST', body: JSON.stringify(dbConfig) ... });
}

function saveDbConnection(targetIndex) {
    const dbConfig = getDbFormData();
    if (!dbConfig) return;
    
    dbConfig.target_index = targetIndex;
    const dbStatusDiv = document.getElementById('dbConnectionStatus');
    
    showMessage('Saving database connection...', 'info', dbStatusDiv);

    // TODO: Replace with actual API call to backend to save connection
    console.log("DB Config:", dbConfig);
    // Simulating success/failure
    setTimeout(() => {
         const success = Math.random() > 0.3; 
         if (success) {
            showMessage(`Database connection '${dbConfig.name}' saved successfully.`, 'success', dbStatusDiv);
            // Optionally clear form or reload saved connections list
            // loadSavedDbConnections(); 
         } else {
             showMessage('Failed to save database connection. Check backend logs.', 'danger', dbStatusDiv);
         }
     }, 1500);
     
    // fetch('/api/connections/db', { method: 'POST', body: JSON.stringify(dbConfig) ... });
}

function getDbFormData() {
     const name = document.getElementById('dbConnectionName').value;
     const type = document.getElementById('dbType').value;
     const host = document.getElementById('dbHost').value;
     const port = document.getElementById('dbPort').value;
     const dbName = document.getElementById('dbName').value;
     const username = document.getElementById('dbUsername').value;
     const password = document.getElementById('dbPassword').value;
     const datatype = document.getElementById('dbDatatype').value;
     const dbStatusDiv = document.getElementById('dbConnectionStatus');

    if (!name || !type || !host || !port || !dbName || !username || !password || !datatype) {
        showMessage('All database connection fields and Data Type are required.', 'warning', dbStatusDiv);
        return null;
    }
    
    return {
        name: name,
        type: type,
        host: host,
        port: parseInt(port, 10),
        database: dbName,
        username: username,
        password: password,
        datatype: datatype
    };
}

// Placeholder for loading saved connections (future enhancement)
// function loadSavedDbConnections() { ... }

// Function to create a new index
async function createIndex(name, settings = {}) {
    try {
        const response = await fetch('/api/admin/indices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                settings: settings
            })
        });
        
        if (!response.ok) throw new Error('Failed to create index');
        
        showToast('Index created successfully', 'success');
        loadIndices(); // Refresh the indices list
        return true;
    } catch (error) {
        console.error('Error creating index:', error);
        showToast('Failed to create index: ' + error.message, 'error');
        return false;
    }
}

// Function to show toast notifications
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

// Add or update showAlert function
function showAlert(type, message) {
    // First check if we should use the existing showToast function
    if (typeof showToast === 'function') {
        showToast(message, type === 'warning' ? 'warning' : type === 'danger' ? 'error' : type);
        return;
    }
    
    // Fallback to basic alert
    const uploadStatus = document.getElementById('uploadStatus');
    if (uploadStatus) {
        uploadStatus.textContent = message;
        uploadStatus.className = `alert alert-${type} mt-3`;
        uploadStatus.style.display = 'block';
    } else {
        alert(message);
    }
}

// Function to display upload results
function displayUploadResults(data) {
    // Store events for later use
    events = data.events;
    totalEvents = data.total_events;
    
    // Show next step
    document.getElementById('step2').style.display = 'block';
    
    // Update columns dropdown
    updateColumnSelect(data.columns);
    
    // Display first page of events
    displayEvents(1);
    
    // Add query options
    const queryDiv = document.getElementById('queryOptions');
    if (queryDiv) {
        const targetIndex = document.getElementById('targetIndex').value.trim();
        
        // Create a "Query This Data" button that opens the search page
        const queryBtn = document.createElement('a');
        queryBtn.href = '/search';
        queryBtn.className = 'btn btn-primary mt-3 me-2';
        queryBtn.innerHTML = '<i class="bi bi-search"></i> Query This Data';
        queryBtn.setAttribute('target', '_blank');
        queryDiv.innerHTML = '';
        queryDiv.appendChild(queryBtn);
        
        // Create a "View Index" button that opens the index management page
        const viewIndexBtn = document.createElement('a');
        viewIndexBtn.href = '/indexes';
        viewIndexBtn.className = 'btn btn-secondary mt-3';
        viewIndexBtn.innerHTML = '<i class="bi bi-table"></i> View Index Data';
        viewIndexBtn.setAttribute('target', '_blank');
        queryDiv.appendChild(viewIndexBtn);
        
        // Add index name as text
        const indexInfo = document.createElement('div');
        indexInfo.className = 'text-muted mt-2';
        indexInfo.textContent = `Indexed to: ${targetIndex}`;
        queryDiv.appendChild(indexInfo);
    }
}

// Function to handle AWS CloudTrail direct upload
function uploadAwsCloudTrail() {
    console.log("AWS CloudTrail upload function called");
    const fileInput = document.getElementById('awsLogFile');
    const targetIndex = document.getElementById('awsTargetIndex').value;
    const datatype = document.getElementById('awsDatatype').value;
    const statusDiv = document.getElementById('awsUploadStatus');
    const spinner = document.getElementById('awsUploadSpinner');
    const uploadBtn = document.getElementById('awsUploadBtn');
    
    // Enhanced debugging - log all elements
    console.log("Elements found:", {
        fileInput: !!fileInput,
        targetIndex: targetIndex, 
        datatype: datatype,
        statusDiv: !!statusDiv,
        spinner: !!spinner,
        uploadBtn: !!uploadBtn
    });
    
    // Validation
    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        console.error("No file selected or file input not found");
        statusDiv.textContent = 'Please select a CloudTrail JSON file';
        statusDiv.className = 'alert alert-warning mt-3';
        statusDiv.style.display = 'block';
        return;
    }
    
    // Security: Confirm AWS index value
    if (targetIndex !== 'aws') {
        console.error("Invalid target index for AWS upload");
        statusDiv.textContent = 'Invalid target index for AWS upload. Must use "aws".';
        statusDiv.className = 'alert alert-warning mt-3';
        statusDiv.style.display = 'block';
        return;
    }
    
    // Security: Confirm AWS datatype
    if (datatype !== 'aws_logs') {
        console.error("Invalid datatype for AWS upload");
        statusDiv.textContent = 'Invalid datatype for AWS upload. Must use "aws_logs".';
        statusDiv.className = 'alert alert-warning mt-3';
        statusDiv.style.display = 'block';
        return;
    }
    
    // Security: Client-side file size validation
    const maxSize = 50 * 1024 * 1024; // 50MB in bytes
    if (fileInput.files[0].size > maxSize) {
        console.error("File too large:", fileInput.files[0].size);
        statusDiv.textContent = `File exceeds maximum size of ${(maxSize / (1024 * 1024)).toFixed(1)}MB`;
        statusDiv.className = 'alert alert-warning mt-3';
        statusDiv.style.display = 'block';
        return;
    }
    
    // Security: Client-side file type validation
    const fileName = fileInput.files[0].name;
    const fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
    if (fileExt !== '.json') {
        console.error("Invalid file type:", fileExt);
        statusDiv.textContent = 'Invalid file type. AWS CloudTrail uploads must be JSON files.';
        statusDiv.className = 'alert alert-warning mt-3';
        statusDiv.style.display = 'block';
        return;
    }
    
    // Show loading indicators
    statusDiv.innerHTML = 'Processing CloudTrail data...';
    statusDiv.className = 'alert alert-info mt-3';
    statusDiv.style.display = 'block';
    uploadBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    // Create FormData object
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('target_index', targetIndex);
    formData.append('datatype', datatype);
    
    console.log("FormData created with:", {
        fileName: fileInput.files[0].name,
        fileSize: fileInput.files[0].size,
        fileType: fileInput.files[0].type,
        targetIndex: targetIndex,
        datatype: datatype
    });
    
    // Send the request with detailed debugging
    console.log("Sending fetch request to /upload endpoint");
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log("Response received:", {
            status: response.status,
            statusText: response.statusText,
            headers: Object.fromEntries([...response.headers])
        });
        
        // Check if response is ok before parsing JSON
        if (!response.ok) {
            console.error("Response not OK:", response.status, response.statusText);
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        return response.json().catch(error => {
            console.error("Error parsing JSON response:", error);
            throw new Error("Invalid response from server: " + error.message);
        });
    })
    .then(data => {
        console.log("Response data:", data);
        uploadBtn.disabled = false;
        spinner.classList.add('d-none');
        
        if (data.success) {
            // Success handling
            statusDiv.className = 'alert alert-success mt-3';
            statusDiv.textContent = `Success! ${data.total_events} CloudTrail events have been indexed to the "${targetIndex}" index.`;
            
            // Reset file input after successful upload
            fileInput.value = '';
            
            // Add query options
            const queryDiv = document.getElementById('awsQueryOptions');
            queryDiv.innerHTML = '';
            
            // Create a "View Data" button
            const viewDataBtn = document.createElement('a');
            viewDataBtn.href = '/indexes';
            viewDataBtn.className = 'btn btn-primary mt-2 me-2';
            viewDataBtn.innerHTML = '<i class="bi bi-table"></i> View Indexed Data';
            viewDataBtn.setAttribute('target', '_blank');
            queryDiv.appendChild(viewDataBtn);
            
            // Create a "Run Query" button
            const queryBtn = document.createElement('a');
            queryBtn.href = '/sql_query';
            queryBtn.className = 'btn btn-secondary mt-2';
            queryBtn.innerHTML = '<i class="bi bi-search"></i> Query CloudTrail Data';
            queryBtn.setAttribute('target', '_blank');
            queryDiv.appendChild(queryBtn);
            
            // Show a hint about the direct upload method
            const hintDiv = document.createElement('div');
            hintDiv.className = 'alert alert-info mt-3';
            hintDiv.innerHTML = '<strong>Note:</strong> This method uploads directly to OpenSearch. CloudTrail data is now stored with the original structure in the "aws" index.';
            queryDiv.appendChild(hintDiv);
            
        } else {
            // Error handling
            statusDiv.className = 'alert alert-danger mt-3';
            statusDiv.textContent = 'Error: ' + (data.error || data.message || 'Unknown error occurred');
            console.error("Upload failed:", data.error || data.message || 'Unknown error');
        }
    })
    .catch(error => {
        console.error("Fetch error:", error);
        uploadBtn.disabled = false;
        spinner.classList.add('d-none');
        
        statusDiv.className = 'alert alert-danger mt-3';
        statusDiv.textContent = 'Error: ' + error.message;
    });
}

    </script>
    
    <!-- AWS CloudTrail Upload Test Script -->
    <script>
        // Add this script to the page just before the end of the file
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AWS CloudTrail test script loaded');
            
            // Function to create a test CloudTrail record
            function createTestCloudTrailRecord() {
                return {
                    "Records": [
                        {
                            "eventVersion": "1.05",
                            "eventTime": "2023-01-01T12:00:00Z",
                            "eventSource": "test.amazonaws.com",
                            "eventName": "TestEvent",
                            "userIdentity": {
                                "type": "IAMUser",
                                "principalId": "TEST123456789",
                                "arn": "arn:aws:iam::123456789012:user/testuser",
                                "accountId": "123456789012",
                                "accessKeyId": "AKIATESTKEY12345",
                                "userName": "testuser"
                            },
                            "awsRegion": "us-east-1",
                            "sourceIPAddress": "192.168.1.1",
                            "requestParameters": {
                                "param1": "value1",
                                "param2": "value2"
                            },
                            "responseElements": {
                                "result": "success"
                            }
                        }
                    ]
                };
            }
            
            // Function to create a test CloudTrail Blob 
            function createTestCloudTrailBlob() {
                const testRecord = createTestCloudTrailRecord();
                const jsonString = JSON.stringify(testRecord);
                return new Blob([jsonString], {type: 'application/json'});
            }
            
            // Add a button for testing directly with a generated sample
            const awsUploadForm = document.getElementById('awsUploadForm');
            if (awsUploadForm) {
                // Add click event for the upload button
                const awsUploadBtn = document.getElementById('awsUploadBtn');
                if (awsUploadBtn) {
                    console.log('Setting up AWS upload button click handler');
                    awsUploadBtn.addEventListener('click', function() {
                        console.log('AWS upload button clicked');
                        uploadAwsCloudTrail();
                    });
                } else {
                    console.error('AWS upload button not found');
                }
                
                // Create a test button element
                const testUploadBtn = document.createElement('button');
                testUploadBtn.type = 'button';
                testUploadBtn.className = 'btn btn-info mt-3';
                testUploadBtn.innerText = 'Test with Sample Data';
                testUploadBtn.addEventListener('click', function() {
                    console.log('Test upload button clicked');
                    
                    const targetIndex = document.getElementById('awsTargetIndex').value;
                    const datatype = document.getElementById('awsDatatype').value;
                    const statusDiv = document.getElementById('awsUploadStatus');
                    
                    // Security: Validate the target index and datatype
                    if (targetIndex !== 'aws') {
                        console.error("Invalid target index for AWS upload");
                        statusDiv.textContent = 'Invalid target index for AWS upload. Must use "aws".';
                        statusDiv.className = 'alert alert-warning mt-3';
                        statusDiv.style.display = 'block';
                        return;
                    }
                    
                    if (datatype !== 'aws_logs') {
                        console.error("Invalid datatype for AWS upload");
                        statusDiv.textContent = 'Invalid datatype for AWS upload. Must use "aws_logs".';
                        statusDiv.className = 'alert alert-warning mt-3';
                        statusDiv.style.display = 'block';
                        return;
                    }
                    
                    // Create a test file
                    const testBlob = createTestCloudTrailBlob();
                    const testFile = new File([testBlob], 'test-cloudtrail.json', {type: 'application/json'});
                    
                    // Create FormData object
                    const formData = new FormData();
                    formData.append('file', testFile);
                    formData.append('target_index', targetIndex);
                    formData.append('datatype', datatype);
                    
                    // Show status
                    statusDiv.innerHTML = 'Uploading test CloudTrail data...';
                    statusDiv.className = 'alert alert-info mt-3';
                    statusDiv.style.display = 'block';
                    
                    // Send request to upload endpoint
                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error || `HTTP error ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Test upload response:', data);
                        if (data.success) {
                            statusDiv.className = 'alert alert-success mt-3';
                            statusDiv.textContent = `Test successful! Sample CloudTrail data uploaded.`;
                            
                            // Add query options
                            const queryDiv = document.getElementById('awsQueryOptions');
                            queryDiv.innerHTML = '';
                            
                            // Create a "View Data" button
                            const viewDataBtn = document.createElement('a');
                            viewDataBtn.href = '/indexes';
                            viewDataBtn.className = 'btn btn-primary mt-2 me-2';
                            viewDataBtn.innerHTML = '<i class="bi bi-table"></i> View Test Data';
                            viewDataBtn.setAttribute('target', '_blank');
                            queryDiv.appendChild(viewDataBtn);
                        } else {
                            statusDiv.className = 'alert alert-danger mt-3';
                            statusDiv.textContent = 'Error: ' + (data.error || data.message || 'Unknown error occurred');
                        }
                    })
                    .catch(error => {
                        console.error("Test upload error:", error);
                        statusDiv.className = 'alert alert-danger mt-3';
                        statusDiv.textContent = 'Error: ' + error.message;
                    });
                });
                
                // Add the button to the form
                awsUploadForm.appendChild(testUploadBtn);
            }
        });
    </script>
{% endblock %} 